<!-- End Navbar -->
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <div class="row">
            <div class="col-6 d-flex align-items-center">
              <h6 class="mb-0">Create new project</h6>
            </div>
            <div class="col-6 text-end">
              <a class="btn mb-0" href="/project"><i class="fas fa-caret-square-left"></i>&nbsp;&nbsp;Go back</a>
            </div>
          </div>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="card card-plain mt-2">
            <div class="card-header pb-0 text-left bg-transparent">
              {{!-- <h3 class="font-weight-bolder text-info text-gradient">Thông tin tài khoản mới</h3> --}}
              <p class="mb-0">Please fill in all the required information below!</p>
              <p class="mb-0 text-danger">{{message}}</p>
            </div>
            <div class="card-body">
              <form role="form" id="formCreateProject" enctype="multipart/form-data">
                <div class="row">
                  <div class="col-xl-6 col-lg-6 col-md-6">
                    <label>Name</label>
                    <div class="mb-3 ms-4 border p-4 mb-2 bg-gray-100 border-radius-lg">
                      <label>Vietnamese</label>
                      <input name="nameVi" type="text" class="form-control" placeholder="Vietnamese name">
                      <label>English</label>
                      <input name="nameEn" type="text" class="form-control" placeholder="English name">
                    </div>
                    <label>Location</label>
                    <div class="mb-3 ms-4 border p-4 mb-2 bg-gray-100 border-radius-lg">
                      <label>Vietnamese</label>
                      <input name="locationVi" type="text" class="form-control" placeholder="Vietnamese location">
                      <label>English</label>
                      <input name="locationEn" type="text" class="form-control" placeholder="English location">
                    </div>
                    <label>Icon (on map)</label>
                    <div class="mb-3">
                      <select name="icon" class="form-control">
                        <option value="">----Choose Icon----</option>
                        {{#each icons}}
                          <option value="{{this._id}}">{{this.name}}</option>
                        {{/each}}
                      </select>
                    </div>
                    <label>Client</label>
                    <div class="mb-3">
                      <select name="customer" class="form-control">
                        <option value="">----Choose Client----</option>
                        {{#each customers}}
                          <option value="{{this._id}}">{{this.name.vi}}</option>
                        {{/each}}
                      </select>
                    </div>
                    
                  </div>
                  
                  <div class="col-xl-6 col-lg-6 col-md-6">
                    <label>Time</label>
                    <div class="mb-3 ms-4 border p-4 mb-2 bg-gray-100 border-radius-lg">
                      <label>Vietnamese</label>
                      <input name="timeVi" type="text" class="form-control" placeholder="Vietnamese Time">
                      <label>English</label>
                      <input name="timeEn" type="text" class="form-control" placeholder="English Time">
                    </div>
                    <label>scope Of Work</label>
                    <div class="mb-3 ms-4 border p-4 mb-2 bg-gray-100 border-radius-lg">
                      <label>Vietnamese</label>
                      <input name="scopeOfWorkVi" type="text" class="form-control" placeholder="abcxyz">
                      <label>English</label>
                      <input name="scopeOfWorkEn" type="text" class="form-control" placeholder="abcxyz">
                    </div>
                    
                    <label>Lat/Long</label>
                    <div class="mb-3">
                      <input name="latLong" type="text" class="form-control" placeholder="[1,1]"
                        id="latLongCreate">
                    </div>
                    <label>Image cover of project</label>
                    <div class="mb-3">
                      <input onchange="previewImageProject(event, 'preview_image_project')"  name="ImageProject" class="form-control" type="file"
                        accept=".png" />
                    </div>
                    <div id="preview_image_project" class="m-3"></div>
                    <label>Oil Field (used by project)</label>
                    <div class="mb-3">
                      <select name="oilField" class="form-control">
                        <option value="">----Choose Oil Field----</option>
                        {{#each fields}}
                          <option value="{{this._id}}">{{this.fieldId}}</option>
                        {{/each}}
                      </select>
                    </div>
                  </div>
                  <div class="row">
                    <label>Services</label>
                    <div class="mb-3 ms-4">
                      <label>Name</label>
                      <select name="nameService" class="form-control" id="nameServiceSelect" multiple>
                        {{#each services}}
                          <option value="{{this._id}}">{{this.name.vi}}</option>
                        {{/each}}
                      </select>
                    </div>
                  </div>
                  <div class="row ms-3" id="dynamicContent">
                    <!-- Content will be loaded here -->
                  </div>
                </div>
                <div class="text-center">
                  <button type="submit" class="btn bg-gradient-dark mt-4 mb-0">Create </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>

  $('#nameServiceSelect').on('change', function () {
    // Get the selected values
    const selectedValues = $(this).val();
    // console.log(selectedValues)
    // loop selectedValues and render code html
    $.ajax({
      url: '/project/getServicesSelect', // Replace with your actual API endpoint
      method: 'POST', // or 'GET' depending on your server configuration
      data: { selectedValues: selectedValues },
      success: function (data) {
        // loop data and render code html
        // console.log(data.services)
        let html = ''
        data.services.forEach(element => {
          html += `
          <div class="col-xl-6 col-lg-6 col-md-6">
            <div class="border p-4 mb-2 bg-gray-100 border-radius-lg">
              <div class="mt-3">
                <label>Service: </label>
                <span class="text-success text-xs font-weight-bold">${element.name.vi}</span>  
              </div>
              <label>Icon</label>
              <select name="iconService_${element._id}" class="form-control">
                <option value="">----Choose icon----</option>
                {{#each icons}}
                  <option value="{{this._id}}">{{this.name}}</option>
                {{/each}}
              </select>
              <div class="mt-3 mb-3">
                <label>Description</label>
                <div class="mb-3 ms-4">
                  <label>Vietnamese</label>
                  <textarea name="desVi_${element._id}" rows="4" class="form-control" placeholder="Vietnamese Description"></textarea>
                  <label>English</label>
                  <textarea name="desEn_${element._id}" rows="4" class="form-control" placeholder="English Description"></textarea>
                </div>
              </div>
              <label>Image Cover</label>
              <div class="mb-3 ">
                <input onchange="previewImage(event, '${element._id}', 'preview_cover')" name="imageServiceCover_${element._id}" class="form-control" type="file"
                  accept=".png" />
              </div>
              <div id="preview_cover_${element._id}" class="m-3"></div>
              <label>Images Gallery</label>
              <div class="mb-3">
                <input onchange="previewImage(event, '${element._id}', 'preview_gallery')" name="imageServiceGallery_${element._id}" class="form-control" type="file" multiple
                  accept=".png" />
              </div>
              <div id="preview_gallery_${element._id}" class="m-3"></div>
            </div>
          </div>
          `
        });
        $('#dynamicContent').html(html)
      },
      error: function (error) {
        // Handle errors
        $('#dynamicContent').html(``)
      }
    });   
  });

  //Hiển thị hình đã chọn
  function previewImage(event, id, previewIdPrefix) {
    const preview = document.querySelector(`#${previewIdPrefix}_${id}`);
    const files = event.target.files;
    preview.innerHTML = "";

    function readAndPreview(file) {
      if (file) {
        const reader = new FileReader();

        reader.addEventListener("load", (e) => {
          const image = new Image();
          //image.height = 50;
          image.width = 85;
          image.title = file.name;
          image.src = e.target.result;
          image.classList = 'm-2'
          preview.appendChild(image);
        }, false);

        reader.readAsDataURL(file);
      }
    }
    if (files) {
      Array.prototype.forEach.call(files, readAndPreview);
    }
  }

  function previewImageProject(event, previewIdPrefix) {
    const preview = document.querySelector(`#${previewIdPrefix}`);
    const files = event.target.files;
    preview.innerHTML = "";

    function readAndPreview(file) {
      if (file) {
        const reader = new FileReader();

        reader.addEventListener("load", (e) => {
          const image = new Image();
          //image.height = 50;
          image.width = 85;
          image.title = file.name;
          image.src = e.target.result;
          image.classList = 'm-2'
          preview.appendChild(image);
        }, false);

        reader.readAsDataURL(file);
      }
    }
    if (files) {
      Array.prototype.forEach.call(files, readAndPreview);
    }
  }
  
  const formCreateProject = document.getElementById('formCreateProject');
  
  formCreateProject.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(formCreateProject);
    

    // print value of formdata
    //for (var value of formData.values()) {
    //   console.log(value);
    //}
    fetch('/project/', {
      method: 'POST',
      body: formData
    }).then((res) => {
      const response = {
        status: res.status,
        data: res.json(),
      }
      return response
    })
      .then(data => {
        data.data.then((val) => {
          if (data.status != 200) {
            Swal.fire({
              position: 'center',
              icon: 'error',
              text: val.message,
              showConfirmButton: false,
              timer: 1500
            })
          } else {
            Swal.fire({
              position: "center",
              icon: "success",
              text: val.message,
              showConfirmButton: false,
              timer: 1500
            }).then(() => {
              window.location.href = "/project"
            });
          }
        })
      })
  })
</script>